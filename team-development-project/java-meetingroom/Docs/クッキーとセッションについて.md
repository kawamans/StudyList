# クッキーとセッションについて

Webアプリケーションでユーザーの情報を保持するための2つの仕組みを解説します。

---

## なぜ必要なのか？

HTTPは「ステートレス」なプロトコルです。

```
リクエスト1: 「ログインします」 → サーバー: 「OK」
リクエスト2: 「マイページ見せて」 → サーバー: 「あなた誰？」
```

サーバーは前のリクエストを覚えていません。
そこで「この人はさっきログインした人だ」と識別する仕組みが必要です。

---

## クッキーとセッションの違い

| | クッキー（Cookie） | セッション（Session） |
|---|-------------------|---------------------|
| **保存場所** | ブラウザ（クライアント側） | サーバー側 |
| **容量** | 約4KB | 制限なし（サーバーのメモリ次第） |
| **有効期限** | 設定可能（数日〜数年） | ブラウザを閉じるまで（設定可能） |
| **セキュリティ** | 低い（ユーザーが見れる） | 高い（サーバーにある） |
| **用途** | 軽い情報、長期保存 | 重要な情報、一時保存 |

---

## 図で理解する

### クッキー

```
┌─────────────┐                    ┌─────────────┐
│  ブラウザ    │                    │  サーバー    │
│             │                    │             │
│ ┌─────────┐ │  ← Set-Cookie     │             │
│ │ Cookie  │ │  username=tanaka  │             │
│ │         │ │                    │             │
│ │ username│ │  Cookie: ────────→│             │
│ │ =tanaka │ │  username=tanaka  │             │
│ └─────────┘ │                    │             │
└─────────────┘                    └─────────────┘
     ↑
  ここに保存（ユーザーが見れる）
```

### セッション

```
┌─────────────┐                    ┌─────────────┐
│  ブラウザ    │                    │  サーバー    │
│             │                    │             │
│ ┌─────────┐ │  ← Set-Cookie     │ ┌─────────┐ │
│ │ Cookie  │ │  JSESSIONID=abc123│ │ Session │ │
│ │         │ │                    │ │         │ │
│ │ SESSION │ │  Cookie: ────────→│ │ user=   │ │
│ │ ID=abc  │ │  JSESSIONID=abc123│ │ tanaka  │ │
│ └─────────┘ │                    │ └─────────┘ │
└─────────────┘                    └─────────────┘
     ↑                                   ↑
  IDだけ保存                        本体はここ（安全）
```

---

## 実際のサービスでの使用例

### クッキーが使われている例

#### 1. ログイン状態の維持（Remember Me）

```
□ ログイン状態を保持する

↓ チェックを入れると...

クッキーに保存: remember_token=xyz789（有効期限: 30日）
→ 30日間はブラウザを閉じても自動ログイン
```

**使用サービス**: Amazon、楽天、Twitter、ほぼ全てのサイト

#### 2. 言語設定

```
サイトの言語: 日本語 / English / 中文

↓ 日本語を選ぶと...

クッキーに保存: lang=ja（有効期限: 1年）
→ 次回アクセス時も日本語で表示
```

**使用サービス**: Google、YouTube、Wikipedia

#### 3. ダークモード設定

```
🌙 ダークモードをON

↓

クッキーに保存: theme=dark
→ 次回も暗い画面で表示
```

**使用サービス**: Twitter、GitHub、YouTube

#### 4. 最近見た商品

```
Amazon: 「最近チェックした商品」

↓

クッキーに保存: recently_viewed=123,456,789
→ 商品IDを保存して次回表示
```

**使用サービス**: Amazon、楽天、ZOZOTOWN

#### 5. ポップアップの非表示設定

```
「このお知らせを今後表示しない」にチェック

↓

クッキーに保存: popup_dismissed=true
→ 次回からポップアップが出ない
```

**使用サービス**: ほぼ全てのサイト

#### 6. アクセス解析（トラッキング）

```
Google Analytics:

クッキーに保存: _ga=GA1.2.123456789.1234567890
→ 同じユーザーかどうか識別（広告の追跡など）
```

**使用サービス**: Google Analytics、Facebook Pixel

#### 7. ショッピングカート（ゲスト用）

```
ログインしていない状態で商品をカートに追加

↓

クッキーに保存: cart=item1:2,item2:1
→ ブラウザを閉じてもカートが残る
```

**使用サービス**: 一部のECサイト

---

### セッションが使われている例

#### 1. ログイン状態の管理

```
ログイン成功！

↓

セッションに保存:
- user_id: 123
- username: "田中さくら"
- email: "tanaka@example.com"
- role: "admin"

→ サーバー側で安全に管理
→ ブラウザにはセッションIDだけ送る
```

**使用サービス**: 全てのログイン機能があるサイト

#### 2. ショッピングカート（ログインユーザー）

```
ログイン後にカートに追加

↓

セッションに保存:
- cart_items: [{id: 1, qty: 2}, {id: 5, qty: 1}]
- total: 3500

→ 他の人に見られたくない情報
```

**使用サービス**: Amazon、楽天、メルカリ

#### 3. 入力フォームの一時保存

```
会員登録フォーム（3ステップ）

ステップ1: 名前、メール入力 → セッションに保存
ステップ2: 住所入力 → セッションに追加
ステップ3: 確認画面 → セッションから読み込み → DB登録
```

**使用サービス**: 会員登録、予約システム

#### 4. ワンタイムトークン（CSRF対策）

```
フォーム表示時:
セッションに保存: csrf_token=abc123
HTMLに埋め込み: <input type="hidden" name="token" value="abc123">

フォーム送信時:
送られてきたtoken と セッションのtoken を比較
→ 一致しなければ不正リクエストとして拒否
```

**使用サービス**: セキュリティを重視する全サイト

#### 5. エラーメッセージの一時表示

```
ログイン失敗

↓

セッションに保存: error="パスワードが違います"
→ リダイレクト
→ 画面表示後にセッションから削除（1回だけ表示）
```

**使用サービス**: ログイン、フォーム送信

#### 6. 検索条件の保持

```
検索: カレー、カテゴリ: 和食、並び順: 新着

↓

セッションに保存:
- keyword: "カレー"
- category: "和食"
- sort: "newest"

→ ページを移動しても検索条件を保持
```

**使用サービス**: ECサイト、求人サイト

#### 7. 認証コードの一時保存

```
2段階認証:

1. メールに認証コード送信
2. セッションに保存: auth_code=123456, expires=5分後
3. ユーザーがコード入力
4. セッションと照合 → 一致すればOK
```

**使用サービス**: 銀行、Google、Amazon

---

## Javaでの実装

### クッキーの操作

```java
// === クッキーを設定（サーブレット） ===
Cookie cookie = new Cookie("username", "tanaka");
cookie.setMaxAge(60 * 60 * 24 * 30);  // 30日間有効
cookie.setPath("/");                   // サイト全体で有効
response.addCookie(cookie);

// === クッキーを取得 ===
Cookie[] cookies = request.getCookies();
if (cookies != null) {
    for (Cookie c : cookies) {
        if ("username".equals(c.getName())) {
            String username = c.getValue();  // "tanaka"
        }
    }
}

// === クッキーを削除 ===
Cookie cookie = new Cookie("username", "");
cookie.setMaxAge(0);  // 有効期限を0にすると削除
cookie.setPath("/");
response.addCookie(cookie);
```

### セッションの操作

```java
// === セッションに保存（ログイン時） ===
HttpSession session = request.getSession();
session.setAttribute("user", userDTO);

// === セッションから取得 ===
HttpSession session = request.getSession(false);  // なければnull
if (session != null) {
    UserDTO user = (UserDTO) session.getAttribute("user");
}

// === セッションを破棄（ログアウト時） ===
HttpSession session = request.getSession(false);
if (session != null) {
    session.invalidate();  // セッション全体を破棄
}

// === 特定の属性だけ削除 ===
session.removeAttribute("user");

// === セッションの有効期限を設定 ===
session.setMaxInactiveInterval(30 * 60);  // 30分
```

### アプリでのセッション使用例

```java
// LoginServlet.java
@WebServlet("/LoginServlet")
public class LoginServlet extends HttpServlet {

    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        String username = request.getParameter("username");
        String password = request.getParameter("password");

        UserDAO userDAO = new UserDAO(conn);
        UserDTO user = userDAO.login(username, password);

        if (user != null) {
            // ログイン成功 → セッションにユーザー情報を保存
            HttpSession session = request.getSession();
            session.setAttribute("user", user);
            response.sendRedirect("home");
        } else {
            // ログイン失敗
            request.setAttribute("error", "ユーザー名かパスワードが違います");
            request.getRequestDispatcher("/views/jsp/login.jsp").forward(request, response);
        }
    }
}
```

```java
// LogoutServlet.java
@WebServlet("/logout")
public class LogoutServlet extends HttpServlet {

    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        // セッションを破棄
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.invalidate();
        }

        // ホームにリダイレクト
        response.sendRedirect(request.getContextPath() + "/home");
    }
}
```

```jsp
<%-- header.jsp: セッションからユーザー情報を取得 --%>
<%
UserDTO loginUser = null;
HttpSession ses = request.getSession(false);
if (ses != null && ses.getAttribute("user") != null) {
    loginUser = (UserDTO) ses.getAttribute("user");
}
%>

<% if (loginUser != null) { %>
    <p>ようこそ、<%= loginUser.getUsername() %>さん</p>
    <a href="<%= request.getContextPath() %>/logout">ログアウト</a>
<% } else { %>
    <a href="<%= request.getContextPath() %>/views/jsp/login.jsp">ログイン</a>
<% } %>
```

---

## 使い分けの判断基準

### クッキーを使う場合

```
✓ ユーザーに見られても問題ない情報
✓ 長期間保存したい（数日〜数年）
✓ サーバーのメモリを使いたくない
✓ ログインしていなくても保持したい

例:
- 言語設定
- テーマ設定（ダークモード）
- 「次回から表示しない」フラグ
- トラッキングID
```

### セッションを使う場合

```
✓ 機密性の高い情報
✓ ログイン中だけ保持したい
✓ 大きなデータ（カート内容など）
✓ サーバー側で管理したい

例:
- ログイン状態
- ユーザー情報
- ショッピングカート
- 入力途中のフォームデータ
- CSRFトークン
```

### 両方使う場合

```
「ログイン状態を保持する」チェックボックス

□ チェックなし:
  → セッションのみ（ブラウザ閉じたらログアウト）

☑ チェックあり:
  → セッション + クッキー（remember_token）
  → 次回アクセス時にクッキーから自動ログイン
```

---

## セキュリティの注意点

### クッキーの注意点

```java
// 1. HttpOnly属性: JavaScriptからアクセス不可にする
cookie.setHttpOnly(true);

// 2. Secure属性: HTTPS通信でのみ送信
cookie.setSecure(true);

// 3. パスワードなど機密情報は絶対に保存しない！
// NG: cookie.setValue(password);
```

### セッションの注意点

```java
// 1. ログイン成功時にセッションIDを再生成（セッション固定攻撃対策）
request.getSession().invalidate();
HttpSession newSession = request.getSession(true);
newSession.setAttribute("user", user);

// 2. タイムアウトを適切に設定
session.setMaxInactiveInterval(30 * 60);  // 30分

// 3. ログアウト時は確実に破棄
session.invalidate();
```

---

## まとめ

| 項目 | クッキー | セッション |
|------|---------|-----------|
| 保存場所 | ブラウザ | サーバー |
| 容量 | 約4KB | 大容量OK |
| 有効期限 | 長期可能 | ブラウザ閉じるまで |
| セキュリティ | 低い | 高い |
| 主な用途 | 設定保存、トラッキング | ログイン、カート |

### 覚え方

```
クッキー = メモ帳（ユーザーが持ち歩く、誰でも見れる）
セッション = ロッカー（サーバーに預ける、鍵だけ持つ）
```

