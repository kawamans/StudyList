# 要件定義読み解き手順（具体例付き）

## 前提
- Java / MVCモデル
- 要件定義として以下が与えられている
  - 画面定義書
  - 画面遷移図
  - データベース設計図
- 開発対象：CRUDを含む業務システム

ここでは **「ユーザー登録機能」** を例に、
要件定義を **実装できるレベルまで分解する手順** を示す。

---

## 手順①：画面遷移図を確認する

### 目的
システムに **どんな画面があり、どう遷移するか** を把握する。

### 具体例（画面遷移図より）
ログイン画面
↓
ユーザー一覧画面
↓（新規登録）
ユーザー登録画面
↓（登録）
ユーザー一覧画面
### この時点で分かること
- ユーザー登録は「一覧画面」から遷移する
- 登録後は一覧画面に戻る

---

## 手順②：画面を一つ選ぶ（今回はユーザー登録）

### 対象画面
- ユーザー登録画面

以降は **この画面だけに集中** して読み解く。

---

## 手順③：画面定義から「入力項目」を抜き出す

### 画面定義書より

| 項目名 | 入力形式 |
|------|--------|
| ユーザー名 | テキスト |
| メールアドレス | テキスト |
| パスワード | パスワード |

### この段階では考えないこと
- DB
- SQL
- 実装方法

目的は **「何を入力させる画面か」** を知ること。

---

## 手順④：入力チェック（Validation）を考える

### 各項目について自問する
「これはそのまま登録して大丈夫か？」

| 項目 | チェック内容 |
|----|------------|
| ユーザー名 | 未入力NG、文字数制限 |
| メール | 未入力NG、形式チェック、重複チェック |
| パスワード | 未入力NG |

※ これは **Controller / Service 層の責務**。

---

## 手順⑤：DB設計図を見る

### DB設計図より

**users テーブル**

| カラム名 | 型 | 制約 |
|--------|----|----|
| id | INT | PK, 自動採番 |
| name | VARCHAR | NOT NULL |
| email | VARCHAR | UNIQUE |
| password | VARCHAR | NOT NULL |

### ここで分かること
- 登録先は `users` テーブル
- email は重複不可 → 事前チェック or 例外処理が必要

---

## 手順⑥：CRUDを明確にする

### この画面で行うDB操作
- 種別：Create
- SQL：INSERT
- 対象テーブル：users

---

## 手順⑦：処理の流れを文章で書く

### ユーザー登録処理の流れ

1. ユーザー登録画面を表示する
2. 登録ボタンが押される
3. 入力値を取得する
4. 入力チェックを行う
5. エラーがあれば登録画面に戻す
6. 問題なければ users テーブルに INSERT
7. ユーザー一覧画面へリダイレクトする

この流れが **実装の設計図** になる。

---

## 手順⑧：MVCに分解する

### Controller（Servlet）
- UserCreateServlet
  - doGet：登録画面表示
  - doPost：登録処理

### Service
- UserService
  - 入力チェック
  - 登録業務ロジック

### DAO
- UserDao
  - insert(User user)

---

## 最終チェックリスト

- [ ] どの画面か説明できる
- [ ] 何を入力する画面か分かる
- [ ] 入力チェック内容を言語化できる
- [ ] 使うテーブルが分かる
- [ ] CRUDの種類が分かる
- [ ] Servlet名が決められる
- [ ] 処理の流れを文章で説明できる

---

## 結論

要件定義は「読む資料」ではなく  
**画面 → 入力 → DB → 処理の流れ** に分解することで  
**そのまま実装設計になる資料**である。

## 次にやること：実装まで落とし込む手順

### ステップ1：全画面をリストアップする

#### やること
画面遷移図から、システムの全画面を洗い出す。

#### 具体例（レシピアプリの場合）

| No | 画面名 | 機能概要 |
|----|--------|---------|
| 1 | ログイン画面 | ログイン認証 |
| 2 | ユーザー登録画面 | 新規ユーザー登録 |
| 3 | レシピ一覧画面 | 全レシピ表示 |
| 4 | レシピ詳細画面 | レシピ詳細表示 |
| 5 | レシピ作成画面 | 新規レシピ作成 |
| 6 | レシピ編集画面 | レシピ更新 |

#### ポイント
- この段階では「何の画面か」だけ分かればOK
- 細かい仕様は後で考える

---

### ステップ2：画面ごとに処理を分解する

#### やること
各画面について、以下を明確にする：

1. **入力項目** - 何を入力するか
2. **バリデーション** - どんなチェックが必要か
3. **DB操作** - どのテーブルに何をするか（CRUD）
4. **遷移先** - 処理後にどこに行くか

#### 具体例：レシピ作成画面

**1. 入力項目**
- タイトル（テキスト）
- 内容（テキストエリア）
- 画像（ファイル）

**2. バリデーション**
- タイトル：未入力NG、100文字以内
- 内容：未入力NG、5000文字以内
- 画像：5MB以内、形式はjpg/png

**3. DB操作**
- 種別：Create（INSERT）
- テーブル：recipes
- 必要な値：title, content, author_id, image_filename

**4. 遷移**
- 成功時：レシピ一覧画面へリダイレクト
- エラー時：作成画面に戻る（エラー表示）

#### この段階で書き出すフォーマット例

```
【画面名】レシピ作成画面

【入力】
- タイトル（必須、100文字以内）
- 内容（必須、5000文字以内）
- 画像（任意、5MB以内、jpg/png）

【DB操作】
- INSERT INTO recipes (title, content, author_id, image_filename)

【ビジネスロジック】
- 画像ファイルをuploadsフォルダに保存
- ファイル名はUUIDで一意に生成
- author_idはログインユーザーのIDを使用

【遷移】
- 成功 → レシピ一覧画面
- 失敗 → 作成画面（エラー表示）
```

---

### ステップ3：MVC単位に落とし込む

#### やること
ステップ2で分解した処理を、MVC（Model-View-Controller）の各層に割り振る。

#### 分解の基準

**View（JSP）の責務**
- 画面表示のみ
- 入力フォームの定義
- データの表示

**Controller（Servlet）の責務**
- HTTPリクエスト/レスポンスの処理
- パラメータ取得
- Serviceの呼び出し
- 遷移制御

**Service層の責務**
- ビジネスロジック
- バリデーション
- 複数のDAOを組み合わせた処理
- ファイル操作

**DAO層の責務**
- データベースアクセスのみ
- SQL実行
- DTOとの変換

#### 具体例：レシピ作成機能のMVC分解

**View（JSP）**
```
recipeForm.jsp
- タイトル入力欄
- 内容入力欄
- 画像アップロード欄
- 登録ボタン
- エラーメッセージ表示領域
```

**Controller（Servlet）**
```java
RecipeCreateServlet
  doGet()
    - 作成画面を表示
    - セッションチェック（未ログインなら拒否）

  doPost()
    - パラメータ取得（title, content, image）
    - RecipeService.createRecipe()を呼び出し
    - 成功時：一覧画面へリダイレクト
    - 失敗時：エラーをセットして画面に戻る
```

**Service**
```java
RecipeService
  createRecipe(title, content, userId, imagePart, uploadDir)
    - バリデーション実行
      ・タイトル未入力チェック
      ・文字数チェック
      ・画像サイズチェック
    - ファイル保存（FileStorageService使用）
    - RecipeDTO作成
    - RecipeDAO.insert()呼び出し

FileStorageService
  saveFile(Part, uploadDir)
    - UUID生成
    - ファイル拡張子取得
    - ファイル保存
    - ファイル名を返す
```

**DAO**
```java
RecipeDAO
  insert(RecipeDTO)
    - INSERT SQL実行
    - 例外処理
```

**DTO**
```java
RecipeDTO
  - id
  - title
  - content
  - authorId
  - imageFilename
  - createdAt
```

#### MVC分解の手順

1. **画面の処理フローを書く**（ステップ2の内容）
2. **各処理が「どの層」の責務か判断する**
   - HTTP処理 → Controller
   - ビジネスロジック → Service
   - DB操作 → DAO
3. **クラス名とメソッド名を決める**
4. **メソッドの引数と戻り値を決める**

#### 判断基準の例

| 処理内容 | 配置先 | 理由 |
|---------|--------|-----|
| パラメータ取得 | Controller | HTTPリクエストの処理 |
| 未入力チェック | Service | ビジネスルール |
| ファイル保存 | Service | ビジネスロジック |
| INSERT文実行 | DAO | DB操作 |
| リダイレクト | Controller | 遷移制御 |

---

### ステップ4：タスク一覧（WBS）にする

#### やること
MVC分解した結果を、実装タスクとして整理する。

#### WBS作成のポイント

1. **依存関係を考慮する**
   - DTO → DAO → Service → Controller の順で作る
   - 下位層から作ることで、上位層で使える

2. **テストも含める**
   - 各層のテストをタスク化

3. **見積もりを付ける**
   - 慣れてきたら作業時間も記載

#### 具体例：レシピ作成機能のWBS

```
【レシピ作成機能】

□ 1. DTO作成（30分）
  □ RecipeDTO作成
  □ getter/setter実装

□ 2. DAO層実装（1時間）
  □ RecipeDAO.insert()実装
  □ 単体テスト作成
  □ テスト実行・修正

□ 3. Service層実装（2時間）
  □ FileStorageService.saveFile()実装
  □ RecipeService.createRecipe()実装
  □ バリデーション実装
  □ 単体テスト作成
  □ テスト実行・修正

□ 4. Controller実装（1.5時間）
  □ RecipeCreateServlet実装
    □ doGet()実装
    □ doPost()実装
  □ web.xmlまたは@WebServlet設定

□ 5. View実装（1時間）
  □ recipeForm.jsp作成
  □ 入力フォーム作成
  □ エラー表示領域作成

□ 6. 結合テスト（1時間）
  □ 画面からの登録テスト
  □ バリデーションテスト
  □ ファイルアップロードテスト
  □ エラーケーステスト

□ 7. バグ修正・リファクタリング（予備）
```

#### タスク粒度の目安

- **大きすぎる**：「レシピ機能を作る」（4時間以上）
- **適切**：「RecipeService.createRecipe()を実装する」（30分〜2時間）
- **小さすぎる**：「import文を書く」（5分以内）

→ **1タスク = 30分〜2時間程度** が管理しやすい

---

### ステップ5：実装順序を決める

#### 推奨順序

1. **DTO** - データ構造を先に決める
2. **DAO** - DB操作を確立
3. **Service** - ビジネスロジックを実装
4. **Controller** - HTTPハンドリング
5. **View** - 画面作成
6. **テスト** - 動作確認

#### なぜこの順序？

- **下の層から作る**ことで、上の層で使えるものが揃う
- **早い段階でDB操作を確認**できる
- **Viewは最後**でも、PostmanなどでAPIテストできる

---

### 全体の流れまとめ

```
要件定義
  ↓
【ステップ1】全画面リストアップ
  ↓
【ステップ2】画面ごとに処理分解
  - 入力項目
  - バリデーション
  - DB操作
  - 遷移
  ↓
【ステップ3】MVC単位に落とし込み
  - Controller：何をするか
  - Service：何をするか
  - DAO：何をするか
  - DTO：どんなデータか
  - View：何を表示するか
  ↓
【ステップ4】WBS作成
  - タスク一覧化
  - 依存関係整理
  - 見積もり
  ↓
【ステップ5】実装開始
  - DTO → DAO → Service → Controller → View
  - 各層でテスト
```

---

### 実践テンプレート

実際にこの手順で整理する際は、以下のテンプレートが使えます：

#### 画面分解シート

```markdown
## 【画面名】

### 入力項目
- 項目名（型、必須/任意、制約）

### バリデーション
- チェック内容

### DB操作
- CRUD種別：
- テーブル：
- SQL概要：

### ビジネスロジック
- 特記事項

### 遷移
- 成功時：
- 失敗時：
```

#### MVC分解シート

```markdown
## 【機能名】のMVC分解

### View
- ファイル名：
- 表示内容：

### Controller
- クラス名：
- メソッド：
  - doGet()：
  - doPost()：

### Service
- クラス名：
- メソッド：
  - メソッド名(引数): 戻り値 - 処理内容

### DAO
- クラス名：
- メソッド：
  - メソッド名(引数): 戻り値 - SQL概要

### DTO
- クラス名：
- フィールド：
```

この手順に従えば、要件定義から実装まで迷わず進められます。

