# テスト実行手順

このドキュメントでは、レシピアプリのテストコードを実行する手順を説明します。

---

## テストファイル一覧

```
src/main/java/jp/co/recipe/
├── dto/                          # DTO（データ転送オブジェクト）
│   ├── UserDTO.java              ← toString()追加済み
│   ├── RecipeDTO.java            ← toString()追加済み
│   └── RecipeList.java           ← toString()追加済み
├── dao/                          # DAO（データアクセスオブジェクト）
│   ├── UserDAO.java
│   └── RecipeDAO.java
└── test/                         # テスト用クラス
    ├── DTOTest.java              ← DTOのテスト
    ├── UserDAOTest.java          ← UserDAOのテスト
    └── RecipeDAOTest.java        ← RecipeDAOのテスト
```

---

## テストの種類

| テストクラス | テスト対象 | 内容 |
|-------------|-----------|------|
| DTOTest | UserDTO, RecipeDTO, RecipeList | オブジェクトの作成とtoString()確認 |
| UserDAOTest | UserDAO | ログイン、登録、ID検索 |
| RecipeDAOTest | RecipeDAO | 全件取得、ID検索、キーワード検索 |

---

## 事前準備

### 1. toString()メソッドの確認

各DTOクラスにtoString()メソッドが追加されていることを確認します。

**UserDTO.java**
```java
@Override
public String toString() {
    return "UserDTO{" +
            "id=" + id +
            ", username='" + username + "'" +
            ", email='" + email + "'" +
            ", profileImage='" + profileImage + "'" +
            "}";
}
```

**RecipeDTO.java**
```java
@Override
public String toString() {
    return "RecipeDTO{" +
            "id=" + id +
            ", title='" + title + "'" +
            ", content='" + content + "'" +
            ", authorname='" + authorname + "'" +
            ", authorId=" + authorId +
            ", createdAt=" + createdAt +
            ", imageFilename='" + imageFilename + "'" +
            "}";
}
```

**RecipeList.java**
```java
@Override
public String toString() {
    StringBuilder sb = new StringBuilder();
    sb.append("RecipeList[\n");
    for (RecipeDTO recipe : this) {
        sb.append("  ").append(recipe.toString()).append("\n");
    }
    sb.append("]");
    return sb.toString();
}
```

### 2. テスト用データベースの準備

DAOテストを実行する前に、データベースにテスト用のデータを登録しておきます。

```sql
-- ユーザーを登録（UserDAOテスト用）
INSERT INTO users (username, password, email)
VALUES ('テストユーザー', 'password123', 'test@example.com');

-- レシピを登録（RecipeDAOテスト用）
INSERT INTO recipes (title, content, author_id)
VALUES ('カレーライス', '玉ねぎを炒めて...', 1);
```

### 3. MySQLが起動していることを確認

DAOテストはデータベースに接続するため、MySQLが起動している必要があります。

---

## テストの実行方法

### 手順1: Eclipseでテストクラスを開く

```
src/main/java/jp/co/recipe/test/DTOTest.java
```

### 手順2: 右クリックメニューから実行

```
1. テストクラスを右クリック
2. 「実行」を選択
3. 「Javaアプリケーション」を選択
```

### 手順3: コンソールで結果を確認

実行すると、コンソールビューに結果が出力されます。

---

## 各テストの実行と確認

### DTOTest の実行

**実行するファイル**: `DTOTest.java`

**期待する出力**:
```
========== DTO テスト開始 ==========

【テスト1】UserDTO の toString()
----------------------------------------
user1: UserDTO{id=1, username='田中太郎', email='tanaka@example.com', profileImage='profile.jpg'}
user2: UserDTO{id=2, username='山田花子', email='yamada@example.com', profileImage='null'}

【テスト2】RecipeDTO の toString()
----------------------------------------
recipe1: RecipeDTO{id=1, title='カレーライス', content='玉ねぎを炒めて...', authorname='田中太郎', authorId=1, createdAt=null, imageFilename='curry.jpg'}
recipe2: RecipeDTO{id=2, title='肉じゃが', content='じゃがいもを切って...', authorname='null', authorId=2, createdAt=null, imageFilename='nikujaga.jpg'}

【テスト3】RecipeList の toString()
----------------------------------------
リストのサイズ: 3
RecipeList[
  RecipeDTO{id=1, title='カレーライス', ...}
  RecipeDTO{id=2, title='肉じゃが', ...}
  RecipeDTO{id=3, title='味噌汁', ...}
]

========== テスト終了 ==========
```

**確認ポイント**:
- エラーが発生していないこと
- 各フィールドの値が正しく表示されていること
- 日本語が文字化けしていないこと

---

### UserDAOTest の実行

**実行するファイル**: `UserDAOTest.java`

**期待する出力**:
```
========== UserDAO テスト開始 ==========

【テスト1】ログイン成功のテスト
----------------------------------------
入力: username=テストユーザー, password=password123
結果: ログイン成功!
取得したユーザー: UserDTO{id=1, username='テストユーザー', email='test@example.com', profileImage='null'}

【テスト2】ログイン失敗のテスト（間違ったパスワード）
----------------------------------------
入力: username=テストユーザー, password=wrongpassword
結果: OK（正しくnullが返された）

【テスト3】findById のテスト
----------------------------------------
入力: id=1
結果: ユーザーが見つかった
取得したユーザー: UserDTO{id=1, username='テストユーザー', email='test@example.com', profileImage='null'}

========== テスト終了 ==========
```

**確認ポイント**:
- データベース接続エラーが発生していないこと
- 正しいユーザー名・パスワードでログインできること
- 間違ったパスワードでnullが返ること
- IDでユーザーを検索できること

**エラーが出た場合**:
```
エラー発生: Communications link failure
```
→ MySQLが起動していない可能性があります

```
エラー発生: Access denied for user 'root'@'localhost'
```
→ DatabaseConfig.javaのパスワードが間違っている可能性があります

---

### RecipeDAOTest の実行

**実行するファイル**: `RecipeDAOTest.java`

**期待する出力**:
```
========== RecipeDAO テスト開始 ==========

【テスト1】findAll のテスト（全件取得）
----------------------------------------
取得件数: 3件
RecipeList[
  RecipeDTO{id=1, title='カレーライス', content='...', authorname='テストユーザー', authorId=1, createdAt=2024-01-01T12:00, imageFilename='curry.jpg'}
  RecipeDTO{id=2, title='肉じゃが', content='...', authorname='テストユーザー', authorId=1, createdAt=2024-01-02T12:00, imageFilename='null'}
  ...
]

【テスト2】findById のテスト（1件取得）
----------------------------------------
入力: id=1
結果: レシピが見つかった
RecipeDTO{id=1, title='カレーライス', ...}

【テスト3】search のテスト（キーワード検索）
----------------------------------------
入力: keyword=カレー
検索結果: 1件
  RecipeDTO{id=1, title='カレーライス', ...}

【テスト4】findByAuthorId のテスト
----------------------------------------
入力: authorId=1
取得件数: 2件
  RecipeDTO{id=1, title='カレーライス', ...}
  RecipeDTO{id=2, title='肉じゃが', ...}

========== テスト終了 ==========
```

**確認ポイント**:
- 全件取得でレシピが取得できること
- authorname（ユーザー名）がJOINで正しく取得できていること
- キーワード検索で該当レシピのみ取得できること

---

## DBを変更するテスト（注意が必要）

以下のテストはデータベースを変更するため、コメントアウトされています。
実行する場合は注意してください。

### 新規登録テスト

```java
// テスト5: 新規登録（コメントアウト中）
// testInsert();
```

コメントを外して実行すると、データベースにレシピが追加されます。

### 削除テスト

```java
// テスト7: 削除（コメントアウト中）
// testDelete();
```

コメントを外して実行すると、データベースからレシピが削除されます。

---

## トラブルシューティング

### 「Javaアプリケーション」が表示されない

**原因**: プロジェクトにコンパイルエラーがある

**解決方法**:
1. プロジェクトを右クリック → 「リフレッシュ」（F5）
2. メニュー → 「プロジェクト」 → 「クリーン」
3. 赤いエラーマークがついているファイルを確認して修正

### データベース接続エラー

**エラー例**:
```
com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure
```

**解決方法**:
1. MySQLが起動しているか確認
2. `DatabaseConfig.java`の接続情報を確認
   ```java
   String url = "jdbc:mysql://localhost:3306/recipe";
   String user = "root";
   String password = "pass";  // ← 自分のパスワード
   ```

### 文字化け

**症状**: 日本語が「???」や文字化けして表示される

**解決方法**:
1. Eclipseのコンソール設定を確認
   - 「実行」→「実行構成」→「共通」タブ
   - エンコードを「UTF-8」に設定
2. データベースの文字コードを確認
   ```sql
   SHOW VARIABLES LIKE 'character_set%';
   ```

---

## テスト実行のチェックリスト

### 実行前の確認

```
□ MySQLが起動している
□ テスト用のデータがDBに登録されている
□ プロジェクトにコンパイルエラーがない
□ DatabaseConfig.javaの接続情報が正しい
```

### 実行後の確認

```
□ エラーが発生していない
□ 期待した値が出力されている
□ 日本語が正しく表示されている
□ nullが適切に処理されている
```

---

## まとめ

```
1. テストクラスを右クリック → 実行 → Javaアプリケーション
2. コンソールに出力された結果を目視で確認
3. エラーがあれば原因を調査して修正
4. DBを変更するテストは必要なときだけ実行
```

### テストの順番

```
1. DTOTest      ← まずDTOが正しく動くか確認
2. UserDAOTest  ← 次にユーザー関連のDB操作を確認
3. RecipeDAOTest ← 最後にレシピ関連のDB操作を確認
```

DTOテストが成功してからDAOテストを実行すると、問題の切り分けがしやすくなります。
